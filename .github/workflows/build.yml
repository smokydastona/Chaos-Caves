name: Build Fractured Lands

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Auto-increment version
      id: version
      run: |
        # Get current version from build.gradle
        CURRENT_VERSION=$(grep "^version = " build.gradle | sed "s/version = '\(.*\)'/\1/")
        echo "Current version: $CURRENT_VERSION"
        
        # Get commit message
        COMMIT_MSG=$(git log -1 --pretty=%B)
        echo "Commit message: $COMMIT_MSG"
        
        # Parse version
        IFS='.' read -r MAJOR MINOR PATCH <<< "$CURRENT_VERSION"
        
        # Determine version bump based on commit message
        if echo "$COMMIT_MSG" | grep -qiE '^(feat|feature)(\(.*\))?!:|^BREAKING'; then
          # Breaking change -> bump major
          MAJOR=$((MAJOR + 1))
          MINOR=0
          PATCH=0
        elif echo "$COMMIT_MSG" | grep -qiE '^(feat|feature)(\(.*\))?:'; then
          # New feature -> bump minor
          MINOR=$((MINOR + 1))
          PATCH=0
        elif echo "$COMMIT_MSG" | grep -qiE '^(fix|bugfix|hotfix)(\(.*\))?:'; then
          # Bug fix -> bump patch
          PATCH=$((PATCH + 1))
        else
          # No conventional commit -> bump patch
          PATCH=$((PATCH + 1))
        fi
        
        NEW_VERSION="$MAJOR.$MINOR.$PATCH"
        echo "New version: $NEW_VERSION"
        
        # Update build.gradle
        sed -i "s/version = '.*'/version = '$NEW_VERSION'/" build.gradle
        
        echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT
    
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
    
    - name: Setup Gradle
      uses: gradle/actions/setup-gradle@v4
      with:
        gradle-version: '8.1.1'
        
    - name: Build with Gradle
      run: gradle build --no-daemon
      
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: fractured-lands-${{ steps.version.outputs.version }}
        path: build/libs/*.jar
